<!DOCTYPE html>
<html>
<head>
	<title>Leaflet ALA WMS</title>
	<meta charset="utf-8" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
	 <style>
        body {
            padding: 0;
            margin: 0;
        }
        html, body, #map {
            height: 100%;
            width: 100%;
        }
    </style>
</head>
<body>
	<div id="map" ></div>

	<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
	<script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
	<script>

		var map = L.map('map').setView([-29, 136], 5);

		L.tileLayer('https://{s}.tiles.mapbox.com/v3/{id}/{z}/{x}/{y}.png', {
			maxZoom: 18,
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
				'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
				'Imagery © <a href="http://mapbox.com">Mapbox</a>',
			id: 'examples.map-i86knfo3'
		}).addTo(map);



	function getColor(d,max){
		return '%23FD8D3C';
	}
	function getColour(d, max){
		console.log("got: " + d + ", " + max);
		
	    return d > 8000 ? '%23800026' :
           d > 3000  ? '%23BD0026' :
           d > 2000   ? '%23c31A1C' :
           d > 1000  ? '%23FC4E2A' :
           d > 100   ? '%23FD8D3C' :
           d > 10  ? '%23FEB24C' :
           d > 1  ? '%23FED976' :
                      '%23FFEDA0';
		
	}

	function makeSLD(a){
		var s = '<%3Fxml+version%3D"1.0"+encoding%3D"UTF-8"%3F><StyledLayerDescriptor+version%3D"1.0.0"+xmlns%3D"http%3A%2F%2Fwww.opengis.net%2Fsld"><NamedLayer><Name>ALA%3Aaus1<%2FName><UserStyle><Title><%2FTitle><FeatureTypeStyle>';
		var max=0;
		$.each(a, function(index,value){
				if(value.count > max){
					max = value.count;
				}
		});	

		$.each(a, function(index,value){
			s += '<Rule><Filter><PropertyIsEqualTo><PropertyName>name_1<%2FPropertyName>';
			s += '<Literal>' + value.label + '<%2FLiteral><%2FPropertyIsEqualTo><%2FFilter>';	
			s += '<PolygonSymbolizer><Fill><CssParameter name="fill">' + getColour(value.count, max) + '';
			s += '<%2FCssParameter><%2FFill><%2FPolygonSymbolizer><%2FRule>';
		});	

		s += '<%2FFeatureTypeStyle><%2FUserStyle><%2FNamedLayer><%2FStyledLayerDescriptor>';

		return s;
	}

	
	// now get the ALA data - say Eucalypts
	$.ajax({
		url: 'http://biocache.ala.org.au/ws/occurrences/search.json?q=genus:Eucalyptus and year:2000&flimit=500&facets=state&callback=?',
		type: 'GET',
		dataType: 'jsonp',
		success: function(json){
			console.log(json.facetResults[0].fieldResult);
			var sld = makeSLD(json.facetResults[0].fieldResult);
			
			var mywms = L.tileLayer.wms('http://spatial.ala.org.au/geoserver/wms/reflect?sld_body=' + sld, {
			layers: 'ALA:aus1',
			format: 'image/png',
			opacity: 0.7,
			styles: '',
			transparent: true,
			version: '1.1.0',
			attribution: "Atlas of Living Australia"
			});
			mywms.addTo(map);
				
		},
		error: function(e){
			console.log(e.message);
		}	
	});
	

	</script>
</body>
</html>
